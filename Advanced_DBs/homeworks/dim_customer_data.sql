CREATE TABLE DIM_CUSTOMER_DATA (
    CUST_DIM_ID         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    GENDER              VARCHAR2(1),
    EDUCATIONAL_LEVEL   VARCHAR2(50),
    AGE_BUCKET          VARCHAR2(50),
    SALARY_RANGE        NUMBER(1) -- 1 TO 5 percentiles.
);

INSERT INTO DIM_CUSTOMER_DATA (GENDER, EDUCATIONAL_LEVEL, AGE_BUCKET, SALARY_RANGE)
WITH CUSTOMER_PREP AS (
  SELECT
    ID,
    GENDER,
    EDUCATIONAL_LEVEL,
    ANNUAL_INCOME,
    CASE
      WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, BIRTHDAY) / 12) < 25 THEN 'Under 25'
      WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, BIRTHDAY) / 12) BETWEEN 25 AND 40 THEN '25-40'
      ELSE 'Over 40'
    END AS AGE_BUCKET,
    NTILE(5) OVER (ORDER BY ANNUAL_INCOME) AS SALARY_PERCENTILE
  FROM
    CUSTOMERS_DATA
)
SELECT DISTINCT
  GENDER,
  EDUCATIONAL_LEVEL,
  AGE_BUCKET,
  SALARY_PERCENTILE AS SALARY_RANGE 
FROM
  CUSTOMER_PREP;

SELECT * FROM Dim_Customer_Data ORDER BY CUST_DIM_ID;

COMMIT;